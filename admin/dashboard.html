<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin Copyflix</title>
<style>
  body { font-family:'Inter',sans-serif; background:#0d0d0d; color:#fff; margin:0; padding:0; }
  h1 { text-align:center; padding:30px 0; font-size:2rem; }

  /* Onglets Films / SÃ©ries */
  .tabs { display:flex; justify-content:center; margin-bottom:20px; }
  .tab { padding:12px 25px; margin:0 10px; cursor:pointer; border-radius:20px; font-weight:bold; transition:0.3s; background:#1c1c1c; }
  .tab.active { background:#e50914; color:#fff; }

  /* Top buttons */
  .top-buttons { text-align:center; margin-bottom:20px; }
  .top-buttons button { background:#e50914; border:none; color:#fff; padding:12px 20px; margin:0 10px; cursor:pointer; border-radius:8px; font-weight:bold; transition:0.3s; }
  .top-buttons button:hover { background:#f6121d; }

  /* Grille type Netflix */
  #tree-view { display:grid; grid-template-columns: repeat(auto-fill,minmax(150px,1fr)); gap:15px; max-width:1200px; margin:0 auto 50px; }
  .tree-item { position:relative; background:#1c1c1c; border-radius:12px; overflow:hidden; cursor:pointer; transition:0.3s; }
  .tree-item img { width:100%; display:block; border-radius:12px; }

  /* EncadrÃ© titre sous l'image */
  .tree-item .title-box {
    position:absolute;
    bottom:0;
    width:100%;
    background:rgba(0,0,0,0.6);
    padding:6px 8px;
    text-align:center;
    font-weight:bold;
    font-size:0.95rem;
    color:#fff;
    border-bottom-left-radius:12px;
    border-bottom-right-radius:12px;
  }

  .tree-item:hover { transform:scale(1.03); box-shadow:0 8px 20px rgba(0,0,0,0.7); }

  /* bouton modifier */
  .edit-btn { position:absolute; top:5px; right:5px; background:#e50914; border:none; color:#fff; padding:4px 6px; border-radius:8px; cursor:pointer; font-size:0.85rem; transition:0.2s; }
  .edit-btn:hover { background:#f6121d; }

  /* Panel flottant */
  #panel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#1c1c1c; padding:30px 25px; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,0.7); z-index:1000; width:350px; }
  #panel h2 { margin-top:0; margin-bottom:20px; text-align:center; font-size:1.5rem; }
  #panel form label { display:block; margin-bottom:6px; font-weight:bold; }
  #panel form input, #panel form select { width:100%; padding:10px; margin-bottom:15px; border-radius:6px; border:1px solid #444; background:#2a2a2a; color:#fff; font-size:1rem; }
  #panel form button { width:48%; margin:0 1%; padding:10px; border-radius:8px; border:none; background:#e50914; color:#fff; font-weight:bold; cursor:pointer; transition:0.3s; }
  #panel form button:hover { background:#f6121d; }

  @media(max-width:480px){ #panel { width:90%; } .top-buttons button { display:block; width:80%; margin:8px auto; } }
</style>
</head>
<body>

<h1>Admin Copyflix</h1>

<div class="tabs">
  <div class="tab active" data-type="Film">Films</div>
  <div class="tab" data-type="SÃ©rie">SÃ©ries</div>
</div>

<div class="top-buttons">
  <button id="btn-logout">DÃ©connexion</button>
  <button id="btn-add-folder">Ajouter Dossier</button>
  <button id="btn-add-film">Ajouter Film/SÃ©rie</button>
  <button id="btn-copy-json">ðŸ“‹ Copier JSON</button>
</div>

<div id="tree-view"></div>

<div id="panel">
  <h2 id="panel-title"></h2>
  <form id="panel-form">
    <input type="hidden" id="item-id">
    <label>Titre:</label>
    <input type="text" id="item-title" required>
    <div id="type-field">
      <label>Type:</label>
      <select id="item-type">
        <option value="Film">Film</option>
        <option value="SÃ©rie">SÃ©rie</option>
        <option value="Folder">Dossier</option>
      </select>
    </div>
    <div id="video-field">
      <label>Lien vidÃ©o :</label>
      <input type="text" id="item-video" placeholder="https://...">
    </div>
    <div id="image-field">
      <label>Image / Jaquette :</label>
      <input type="text" id="item-image" placeholder="https://...">
    </div>
    <label>Dossier parent:</label>
    <select id="item-parent"></select>
    <div style="display:flex; justify-content: space-between;">
      <button type="submit">Valider</button>
      <button type="button" id="btn-close-panel">Fermer</button>
    </div>
  </form>
</div>

<script>
let data = { folders: [], films: [] }; 
let currentFilter = "Film";

const treeView = document.getElementById("tree-view");
const panel = document.getElementById("panel");
const panelTitle = document.getElementById("panel-title");
const panelForm = document.getElementById("panel-form");

// onglets
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentFilter = tab.dataset.type;
    renderTree();
  });
});

// boutons
document.getElementById("btn-logout").addEventListener("click",()=>window.location.href="../index.html");
document.getElementById("btn-add-folder").addEventListener("click",()=>openPanel("Folder"));
document.getElementById("btn-add-film").addEventListener("click",()=>openPanel("Film"));
document.getElementById("btn-close-panel").addEventListener("click",closePanel);
panelForm.addEventListener("submit",submitForm);
document.getElementById("btn-copy-json").addEventListener("click", ()=>{
  navigator.clipboard.writeText(JSON.stringify(data,null,2)).then(()=>alert("JSON copiÃ© !")).catch(()=>alert("Impossible de copier"));
});

// charger data.json
fetch('../data.json')
  .then(res => res.json())
  .then(json => {
    data = json;
    renderTree();
  })
  .catch(err => console.error("Erreur en chargeant data.json :", err));

// PANEL
function openPanel(type,item=null){
  panel.style.display="block";
  panelTitle.textContent = item ? "Modifier "+item.title : type==="Folder"?"Ajouter Dossier":"Ajouter Film/SÃ©rie";
  document.getElementById("item-id").value = item?.id || "";
  document.getElementById("item-title").value = item?.title || "";
  document.getElementById("item-type").value = item?.type || type;
  document.getElementById("item-video").value = item?.video || "";
  document.getElementById("item-image").value = item?.image || "";
  populateParentOptions(item?.id,type);
  if(type==="Folder"){document.getElementById("type-field").style.display="none"; document.getElementById("video-field").style.display="none";}
  else{document.getElementById("type-field").style.display="block"; document.getElementById("video-field").style.display="block";}
}

function closePanel(){panel.style.display="none"; panelForm.reset();}

// populate parent options
function populateParentOptions(skipId,type){
  const sel = document.getElementById("item-parent");
  sel.innerHTML='<option value="">-- Aucun --</option>';
  function addOptions(folders, level = 0){
    folders.forEach(f => {
      if(f.id !== skipId){
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = 'â€”'.repeat(level) + ' ' + f.title;
        sel.appendChild(opt);
        if(f.children && f.children.length){
          addOptions(f.children.filter(c => c.type === "Folder"), level + 1);
        }
      }
    });
  }
  addOptions(data.folders);
}

// submit form
function submitForm(e){
  e.preventDefault();
  const id=document.getElementById("item-id").value||"id-"+Date.now();
  const title=document.getElementById("item-title").value;
  const type=document.getElementById("item-type").value;
  const video=document.getElementById("item-video").value;
  const image=document.getElementById("item-image").value;
  const parentId=document.getElementById("item-parent").value;

  const newItem={id,title,type,video,image,children:[],expanded:false};

  if(parentId){
    const parent=findItem(parentId,data);
    parent.children=parent.children||[];
    const idx=parent.children.findIndex(c=>c.id===id);
    if(idx>=0) parent.children[idx]=newItem;
    else parent.children.push(newItem);
  } else {
    let arr = type==="Folder"?data.folders:data.films;
    const idx=arr.findIndex(c=>c.id===id);
    if(idx>=0) arr[idx]=newItem;
    else arr.push(newItem);
  }

  saveData(); renderTree(); closePanel();
}

// find item
function findItem(id,root){
  let res=null;
  function search(arr){
    for(const i of arr){
      if(i.id===id){res=i; return;}
      if(i.children) search(i.children);
    }
  }
  search(root.folders||root);
  search(root.films||[]);
  return res;
}

// save
function saveData(){localStorage.setItem("copyflixData",JSON.stringify(data));}

// render
function renderTree(){
  treeView.innerHTML="";

  let items = [];
  data.folders.forEach(f=>{ if(containsType(f,currentFilter)) items.push(f); });
  if(currentFilter==="Film") items = items.concat(data.films.filter(f=>f.type==="Film"));
  if(currentFilter==="SÃ©rie") items = items.concat(data.films.filter(f=>f.type==="SÃ©rie"));

  items.forEach(i=>renderItem(i,treeView));
}

function containsType(folder,type){
  if(folder.children && folder.children.length){
    for(const c of folder.children){
      if(c.type===type) return true;
      if(c.type==="Folder" && containsType(c,type)) return true;
    }
  }
  return false;
}

function renderItem(item,parentEl){
  const div = document.createElement("div");
  div.className="tree-item";
  div.dataset.id = item.id;

  const img = document.createElement("img");
  img.src = item.image || "https://via.placeholder.com/150x225?text=?";
  div.appendChild(img);

  const titleBox = document.createElement("div");
  titleBox.className = "title-box";
  titleBox.textContent = item.title;
  div.appendChild(titleBox);

  // bouton modifier
  const editBtn = document.createElement("button");
  editBtn.textContent = "âœï¸";
  editBtn.className="edit-btn";
  editBtn.addEventListener("click",(e)=>{
    e.stopPropagation();
    openPanel(item.type,item);
  });
  div.appendChild(editBtn);

  div.addEventListener("click",()=>{
    if(item.type==="Folder"){
      item.expanded = !item.expanded;
      renderTree();
    } else {
      openPanel(item.type,item);
    }
  });

  parentEl.appendChild(div);

  // enfants si dossier ouvert
  if(item.type==="Folder" && item.expanded && item.children){
    item.children.forEach(c=>{
      if(c.type === currentFilter || c.type==="Folder") renderItem(c,parentEl);
    });
  }
}
</script>
</body>
</html>
