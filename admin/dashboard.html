<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin Copyflix</title>
<style>
  body { font-family:'Inter',sans-serif; background:#0d0d0d; color:#fff; margin:0; padding:0; }
  h1 { text-align:center; padding:30px 0; font-size:2rem; }
  .top-buttons { text-align:center; margin-bottom:20px; }
  .top-buttons button { background:#e50914; border:none; color:#fff; padding:12px 20px; margin:0 10px; cursor:pointer; border-radius:8px; font-weight:bold; transition:0.3s; }
  .top-buttons button:hover { background:#f6121d; }
  #tree-view { max-width:900px; margin:0 auto 50px auto; background:#1c1c1c; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.5); }
  .tree-item { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; margin:5px 0; background:#2a2a2a; border-radius:6px; transition:0.2s; cursor:grab; }
  .tree-item:hover { background:#3a3a3a; }
  .tree-buttons button { background:#ff4b3e; padding:4px 10px; font-size:0.85rem; border-radius:4px; margin-left:5px; transition:0.2s; cursor:pointer; }
  .tree-buttons button:hover { background:#ff6f61; }
  .tree-children { margin-left:20px; }
  #panel { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#1c1c1c; padding:30px 25px; border-radius:12px; box-shadow:0 8px 25px rgba(0,0,0,0.7); z-index:1000; width:350px; }
  #panel h2 { margin-top:0; margin-bottom:20px; text-align:center; font-size:1.5rem; }
  #panel form label { display:block; margin-bottom:6px; font-weight:bold; }
  #panel form input, #panel form select { width:100%; padding:10px; margin-bottom:15px; border-radius:6px; border:1px solid #444; background:#2a2a2a; color:#fff; font-size:1rem; }
  #panel form button { width:48%; margin:0 1%; padding:10px; border-radius:8px; border:none; background:#e50914; color:#fff; font-weight:bold; cursor:pointer; transition:0.3s; }
  #panel form button:hover { background:#f6121d; }
  @media(max-width:480px){ #panel { width:90%; } .top-buttons button { display:block; width:80%; margin:8px auto; } }
</style>
</head>
<body>

<h1>Admin Copyflix</h1>

<div class="top-buttons">
  <button id="btn-logout">D√©connexion</button>
  <button id="btn-add-folder">Ajouter Dossier</button>
  <button id="btn-add-film">Ajouter Film/S√©rie</button>
  <button id="btn-copy-json">üìã Copier JSON</button>
</div>

<div id="tree-view"></div>

<div id="panel">
  <h2 id="panel-title"></h2>
  <form id="panel-form">
    <input type="hidden" id="item-id">
    <label>Titre:</label>
    <input type="text" id="item-title" required>
    <div id="type-field">
      <label>Type:</label>
      <select id="item-type">
        <option value="Film">Film</option>
        <option value="S√©rie">S√©rie</option>
        <option value="Folder">Dossier</option>
      </select>
    </div>
    <div id="video-field">
      <label>Lien vid√©o :</label>
      <input type="text" id="item-video" placeholder="https://...">
    </div>
    <div id="image-field">
      <label>Image / Jaquette :</label>
      <input type="text" id="item-image" placeholder="https://...">
    </div>
    <label>Dossier parent:</label>
    <select id="item-parent"></select>
    <div style="display:flex; justify-content: space-between;">
      <button type="submit">Valider</button>
      <button type="button" id="btn-close-panel">Fermer</button>
    </div>
  </form>
</div>

<script>
let data = JSON.parse(localStorage.getItem("copyflixData") || '{"folders":[],"films":[] }');

const treeView = document.getElementById("tree-view");
const panel = document.getElementById("panel");
const panelTitle = document.getElementById("panel-title");
const panelForm = document.getElementById("panel-form");

// BUTTONS
document.getElementById("btn-logout").addEventListener("click",()=>window.location.href="../index.html");
document.getElementById("btn-add-folder").addEventListener("click",()=>openPanel("Folder"));
document.getElementById("btn-add-film").addEventListener("click",()=>openPanel("Film"));
document.getElementById("btn-close-panel").addEventListener("click",closePanel);
panelForm.addEventListener("submit",submitForm);

// BOUTON COPIER JSON
document.getElementById("btn-copy-json").addEventListener("click", ()=>{
  navigator.clipboard.writeText(JSON.stringify(data,null,2))
  .then(()=>alert("JSON copi√© !"))
  .catch(()=>alert("Impossible de copier"));
});

renderTree();

// PANEL
function openPanel(type,item=null){
  panel.style.display="block";
  panelTitle.textContent = item ? "Modifier "+item.title : type==="Folder"?"Ajouter Dossier":"Ajouter Film/S√©rie";
  document.getElementById("item-id").value = item?.id || "";
  document.getElementById("item-title").value = item?.title || "";
  document.getElementById("item-type").value = item?.type || type;
  document.getElementById("item-video").value = item?.video || "";
  document.getElementById("item-image").value = item?.image || "";
  populateParentOptions(item?.id,type);
  if(type==="Folder"){document.getElementById("type-field").style.display="none"; document.getElementById("video-field").style.display="none";}
  else{document.getElementById("type-field").style.display="block"; document.getElementById("video-field").style.display="block";}
}

function closePanel(){panel.style.display="none"; panelForm.reset();}

// REMPLIR LISTE DOSSIERS PARENTS RECURSIVE
function populateParentOptions(skipId,type){
  const sel = document.getElementById("item-parent");
  sel.innerHTML='<option value="">-- Aucun --</option>';

  function addOptions(folders, level = 0){
    folders.forEach(f => {
      if(f.id !== skipId){
        const opt = document.createElement("option");
        opt.value = f.id;
        opt.textContent = '‚Äî'.repeat(level) + ' ' + f.title; // indentation
        sel.appendChild(opt);
        if(f.children && f.children.length){
          addOptions(f.children.filter(c => c.type === "Folder"), level + 1);
        }
      }
    });
  }

  addOptions(data.folders);
}

// FORM SUBMIT
function submitForm(e){
  e.preventDefault();
  const id=document.getElementById("item-id").value||"id-"+Date.now();
  const title=document.getElementById("item-title").value;
  const type=document.getElementById("item-type").value;
  const video=document.getElementById("item-video").value;
  const image=document.getElementById("item-image").value;
  const parentId=document.getElementById("item-parent").value;

  const newItem={id,title,type,video,image,children:[]};

  if(parentId){
    const parent=findItem(parentId,data);
    parent.children=parent.children||[];
    const idx=parent.children.findIndex(c=>c.id===id);
    if(idx>=0) parent.children[idx]=newItem;
    else parent.children.push(newItem);
  } else {
    let arr = type==="Folder"?data.folders:data.films;
    const idx=arr.findIndex(c=>c.id===id);
    if(idx>=0) arr[idx]=newItem;
    else arr.push(newItem);
  }

  saveData(); renderTree(); closePanel();
}

// RECHERCHE D'UN ITEM
function findItem(id,root){
  let res=null;
  function search(arr){
    for(const i of arr){
      if(i.id===id){res=i; return;}
      if(i.children) search(i.children);
    }
  }
  search(root.folders||root);
  search(root.films||[]);
  return res;
}

// SAUVEGARDE
function saveData(){localStorage.setItem("copyflixData",JSON.stringify(data));}

// RENDER TREE
function renderTree(){
  treeView.innerHTML="";
  data.folders.forEach(f=>renderItem(f,treeView));
  data.films.forEach(f=>renderItem(f,treeView));
}

function renderItem(item,parentEl){
  const div=document.createElement("div");
  div.className="tree-item";
  div.dataset.id=item.id;
  div.draggable=true;

  let icon="";
  if(item.type==="Folder") icon="üìÅ";
  else if(item.type==="Film") icon="üé¨";
  else icon="üì∫";

  div.innerHTML=`<span>${icon} ${item.title}</span>`;
  
  const btns=document.createElement("span");
  btns.className="tree-buttons";

  const mod=document.createElement("button");
  mod.textContent="‚úèÔ∏è";
  mod.onclick=(e)=>{e.stopPropagation(); openPanel(item.type,item);};
  btns.appendChild(mod);

  const del=document.createElement("button");
  del.textContent="üóë";
  del.onclick=(e)=>{e.stopPropagation(); deleteItem(item.id);};
  btns.appendChild(del);

  div.appendChild(btns);
  parentEl.appendChild(div);

  if(item.children && item.children.length){
    const cont=document.createElement("div");
    cont.className="tree-children";
    item.children.forEach(c=>renderItem(c,cont));
    parentEl.appendChild(cont);
  }

  div.addEventListener("dragstart",dragStart);
  div.addEventListener("dragover",dragOver);
  div.addEventListener("drop",drop);
}

// DRAG & DROP
let draggedId=null;
function dragStart(e){draggedId=this.dataset.id;}
function dragOver(e){e.preventDefault();}
function drop(e){
  e.preventDefault();
  if(draggedId===this.dataset.id) return;

  const dragged=findAndRemove(draggedId,data);
  const parent=findParentArray(this.dataset.id,data) || data.folders;
  const idx=parent.findIndex(i=>i.id===this.dataset.id);
  parent.splice(idx,0,dragged);

  saveData(); renderTree();
}

function findAndRemove(id,root){
  let res=null;
  function search(arr){
    for(let i=0;i<arr.length;i++){
      if(arr[i].id===id){res=arr.splice(i,1)[0]; return;}
      if(arr[i].children) search(arr[i].children);
    }
  }
  search(root.folders||root);
  search(root.films||[]);
  return res;
}

function findParentArray(id,root){
  let res=null;
  function search(arr){
    for(const i of arr){
      if(i.id===id){res=arr; return;}
      if(i.children) search(i.children);
    }
  }
  search(root.folders||root);
  search(root.films||[]);
  return res;
}

// DELETE
function deleteItem(id){
  findAndRemove(id,data);
  saveData(); renderTree();
}
</script>
</body>
</html>
